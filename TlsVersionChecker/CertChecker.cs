using System;
using System.Diagnostics;
using System.Net;
using Renci.SshNet;

namespace TlsVersionChecker
{
    public class CertChecker
    {
        public async Task CheckVulnerabilities(string url)
        {
            try
            {
                // Check Heartbleed vulnerability over HTTPS
                bool heartbleedVulnerable = await CheckHeartbleedVulnerability(url);
                Console.WriteLine($"Heartbleed vulnerability for {url}: {(heartbleedVulnerable ? "Vulnerable" : "Not vulnerable")}");

                // Check FTP vulnerability
                bool ftpVulnerable = await CheckFTPVulnerability(url);
                Console.WriteLine($"FTP vulnerability for {url}: {(ftpVulnerable ? "Vulnerable" : "Not vulnerable")}");

                // Check SSH vulnerability
                bool sshVulnerable = await CheckSSHVulnerability(url);
                Console.WriteLine($"SSH vulnerability for {url}: {(sshVulnerable ? "Vulnerable" : "Not vulnerable")}");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"An error occurred while checking vulnerabilities for {url}: {ex.Message}");
            }
        }

        public async Task<bool> CheckHeartbleedVulnerability(string url)
        {
            try
            {
                Process process = new Process();
                ProcessStartInfo startInfo = new ProcessStartInfo
                {
                    FileName = "openssl",
                    Arguments = $"s_client -connect {url}:443 -tlsextdebug 2>&1 | grep 'server extension \"heartbeat\" (id=15)'",
                    RedirectStandardOutput = true,
                    UseShellExecute = false,
                    CreateNoWindow = true
                };
                process.StartInfo = startInfo;
                process.Start();

                string output = await process.StandardOutput.ReadToEndAsync();
                process.WaitForExit();

                return output.Contains("server extension \"heartbeat\" (id=15)");
            }
            catch
            {
                return false; // If an error occurs during the process, consider it as not vulnerable
            }
        }

        public async Task<bool> CheckFTPVulnerability(string url)
        {
            try
            {
                // Attempt FTP connection
                FtpWebRequest request = (FtpWebRequest)WebRequest.Create($"ftp://{url}");
                request.Method = WebRequestMethods.Ftp.ListDirectory;
                request.Credentials = new NetworkCredential("anonymous", "");

                using (FtpWebResponse response = (FtpWebResponse)await request.GetResponseAsync())
                {
                    return true; // If the connection succeeds, consider it as vulnerable
                }
            }
            catch
            {
                return false; // If an error occurs during the connection, consider it as not vulnerable
            }
        }

        public async Task<bool> CheckSSHVulnerability(string url)
        {
            try
            {
                // Attempt SSH connection
                using (var client = new SshClient(url, "username", "password"))
                {
                    client.Connect();
                    client.Disconnect();
                    return true; // If the connection succeeds, consider it as vulnerable
                }
            }
            catch
            {
                return false; // If an error occurs during the connection, consider it as not vulnerable
            }
        }
    }
}

